<html>
<pre>
<code>
import serial
import csv
import numpy as np

# --- Konstanta ---
NUM_BEAMS = 136
SCAN_HEIGHT_M = 3.0
PITCH = SCAN_HEIGHT_M / NUM_BEAMS  # ≈ 0.022 m per beam

# --- Serial config ---


def beam_to_height(beam_idx: int) -> float:
    """Konversi nomor beam tertinggi tertutup → tinggi dalam meter."""
    if beam_idx <= 0 or beam_idx > NUM_BEAMS:
        return 0.0
    return beam_idx * PITCH

def moving_average(x, w=5):
    return np.convolve(x, np.ones(w)/w, mode='valid')

def classify_vehicle(heights):
    if len(heights) < 5:
        return "UNKNOWN"

    H_p95 = np.percentile(heights, 95)
    H_mean = np.mean(heights)
    H_std = np.std(heights)   # variasi profil

    dH = np.diff(heights)
    ΔH_max_up = max(
        [np.sum(dH[i:i+3]) for i in range(len(dH)-2)], default=0
    )

    K = np.abs(np.diff(heights, n=2))
    K_mean = np.mean(K) if len(K) > 0 else 0

    # Hitung plateau
    plateaus = 0
    tol = 0.02
    run_len = 1
    for i in range(1, len(heights)):
        if abs(heights[i] - heights[i-1]) < tol:
            run_len += 1
        else:
            if run_len >= 10:
                plateaus += 1
            run_len = 1
    if run_len >= 10:
        plateaus += 1

    # --- Aturan baru ---
    # 1. Bus (atap tinggi & rata)
    print("Tinggi   : ", f"{H_p95:.3f}")
    print("Kerataan : ", f"{H_std:.3f}")
    if H_p95 >= 2.8 and H_std < 0.09:
        return "BUS"

    # 2. Minibus
    if (2.50 <= H_p95 <= 3.00 and ΔH_max_up < 0.12 and K_mean < 0.03):
        return "MINIBUS"

    # 3. Truk engkel
    if (2.30 <= H_p95 <= 2.70 and (ΔH_max_up >= 0.18 or plateaus >= 2)):
        return "TRUK_ENGKEL"

    # 4. Resolusi ambiguitas
    if ΔH_max_up >= 0.18 or plateaus >= 2:
        return "TRUK_ENGKEL"
    elif ΔH_max_up < 0.12 and K_mean < 0.03:
        return "MINIBUS"
    else:
        return "MINIBUS" if H_mean >= 2.65 else "TRUK_ENGKEL"

def main():

    heights = []
    idle_counter = 0
    with open("data.csv", "r", newline="", encoding="utf-8") as file:
        reader = csv.reader(file)
        for row in reader:
            data = str (row)
            if row:  # pastikan tidak kosong
                beam_idx = int(row[0])
                h = beam_to_height(beam_idx)

                if h > 0:
                    heights.append(h)
                    idle_counter = 0
                    #print(f"Scan tinggi: {h:.2f} m (beam {beam_idx})")
                else:
                    # beam_idx=0 → tidak ada kendaraan (jalan kosong)
                    idle_counter += 1
                    #print("Counter : ",idle_counter)
        # Potong 10% data awal
        #cut = int(len(heights)/25)
        del heights[0:3]

        #Potong 10% data akhir
        del heights[-2:]

        H_smoothed = moving_average(np.array(heights), w=5)
        kelas = classify_vehicle(H_smoothed)
        print(f"\n>>> Kendaraan terdeteksi: {kelas}\n")
        heights.clear()

if __name__ == "__main__":
    main()
</code>
</pre>
</html>
